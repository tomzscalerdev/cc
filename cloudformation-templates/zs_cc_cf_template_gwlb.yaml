AWSTemplateFormatVersion: 2010-09-09
Description: Zscaler Cloud Connector GWLB Template
Metadata:
  LICENSE: 'Apache License, Version 2.0'
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Cloud Connector Instances
        Parameters:
          - Ec2Instances
          - Ec2InstancesHttpProbePort
          - GwlbHealthCheckInterval
          - GwlbHealthyThreshold
          - GwlbUnhealthyThreshold
          - GwlbTargetGroupRebalanceOnDeregistrationOrUnhealthy
          - GwlbFlowStickiness
          - GwlbCrossZoneLbEnabled

    ParameterLabels:
      Ec2Instances:
        default: ZS CC instance IDs
      Ec2InstancesHttpProbePort:
        default: ZS CC instance Http Probe Port
      GwlbCrossZoneLbEnabled:
        default: Enable Cross-zone Loadbalancing
      GwlbHealthCheckInterval:
        default: GWLB probe Health Check Interval
      GwlbHealthyThreshold:
        default: GWLB probe Healthy Threshold
      GwlbUnhealthyThreshold:
        default: GWLB probe Unhealthy Threshold
      GwlbTargetGroupRebalanceOnDeregistrationOrUnhealthy:
        default: GWLB target failover rebalance strategy
      GwlbFlowStickiness:
        default: GWLB Flow Stickiness strategy
  cfn-lint:
    config:
      ignore_checks:
        - E9007
        - W2001
        - E3003
        - E2523
Transform:
  - Name: ZSCC-Macro
    Parameters:
      operation : ZSCCGWLB
Parameters:
  Ec2Instances:
    Type: List<AWS::EC2::Instance::Id>
    Description: >-
      AWS EC2 Instance IDs for ZS Cloud Connectors that are to be added to the
      GWLB
  Ec2InstancesHttpProbePort:
    Type: String
    AllowedPattern: >-
      ^(80|102[4-9]|10[3-9]\d|1[1-9]\d{2}|[2-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$
    ConstraintDescription: 'The HTTP probe port''s allowed values are [80, 1024-65535]'
    Description: >-
      The Http Probe Healthcheck Port for ZS Cloud Connectors. Allowed values
      are [80, 1024-65535]
  GwlbCrossZoneLbEnabled:
    Type: String
    Description: "Select \"true\" to enable cross-zone loadbalancing (default), else \"false\""
    Default: true
    AllowedValues:
      - true
      - false
  GwlbHealthCheckInterval:
    Type: Number
    MinValue: 5
    MaxValue: 300
    ConstraintDescription: >-
      Health Check Interval: Minimum 5 and maximum 300 seconds
    Description: "Interval for GWLB target group health check probing, in seconds, of Cloud Connector targets"
    Default: 20
  GwlbHealthyThreshold:
    Type: Number
    MinValue: 2
    MaxValue: 10
    ConstraintDescription: >-
      Healthy Threshold: Minimum 2 and maximum 10
    Description: "The number of successful health checks required before an unhealthy target becomes healthy"
    Default: 2
  GwlbUnhealthyThreshold:
    Type: Number
    MinValue: 2
    MaxValue: 10
    ConstraintDescription: >-
      UnHealthy Threshold: Minimum 2 and maximum 10
    Description: "The number of unsuccessful health checks required before a healthy target becomes unhealthy"
    Default: 3
  GwlbTargetGroupRebalanceOnDeregistrationOrUnhealthy:
    Type: String
    Description: "Select \"rebalance\" to enable rebalance failover on target deregistration or of target becomes unhealthy"
    AllowedValues:
      - no_rebalance
      - rebalance
    Default: rebalance
  GwlbFlowStickiness:
    Type: String
    Description: >-
      Select 2-tuple for source_ip_dest_ip, 3-tuple for source_ip_dest_ip_proto flow stickiness
    Default: "5-tuple"
    AllowedValues:
      - "5-tuple"
      - "2-tuple"
      - "3-tuple"

Conditions:
  EnableFlowStickiness: !Not
    - !Equals
        - !Ref GwlbFlowStickiness
        - "5-tuple"
  Use3TupleFlowStickiness: !Equals
    - !Ref GwlbFlowStickiness
    - "3-tuple"


Resources:
  ZSCCGWLBTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckPath: /?cchealth
      HealthCheckPort: !Ref Ec2InstancesHttpProbePort
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: !Ref GwlbHealthCheckInterval
      HealthyThresholdCount: !Ref GwlbHealthyThreshold
      UnhealthyThresholdCount: !Ref GwlbUnhealthyThreshold

      Name: !Join
        - "-"
        - - ZSCCGWLBTargetGroup
          - !Select [4, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]
      Port: 6081
      Protocol: GENEVE
      TargetType: ip
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 0
        - Key: target_failover.on_deregistration
          Value: !Ref GwlbTargetGroupRebalanceOnDeregistrationOrUnhealthy
        - Key: target_failover.on_unhealthy
          Value: !Ref GwlbTargetGroupRebalanceOnDeregistrationOrUnhealthy
        - Key: stickiness.enabled
          Value: !If
            - EnableFlowStickiness
            - true
            - false
        - Key: stickiness.type
          Value: !If
            - Use3TupleFlowStickiness
            - "source_ip_dest_ip_proto"
            - "source_ip_dest_ip"

  ZSCCGWLBListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref ZSCCGWLBTargetGroup
          Type: forward
      LoadBalancerArn: !Ref ZSCCGWLB
  ZSCCVPCEPService:
    Type: 'AWS::EC2::VPCEndpointService'
    Properties:
      AcceptanceRequired: false
      GatewayLoadBalancerArns:
        - !Ref ZSCCGWLB
  ZSCCVPCEP:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      ServiceName: !Join
        - .
        - - com.amazonaws.vpce
          - !Ref AWS::Region
          - !Ref ZSCCVPCEPService
      VpcEndpointType: GatewayLoadBalancer
  ZSCCGWLB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: load_balancing.cross_zone.enabled
          Value: !Ref GwlbCrossZoneLbEnabled
      Name: !Join
        - "-"
        - - ZSCCGWLB
          - !Select [4, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]
      Type: gateway
Outputs:
  ZScalerCCGWLB:
    Description: ZS CC GWLB
    Value: !Ref ZSCCGWLB
  ZSCCVPCEPService:
    Description: ZSCCVPCEPService
    Value: !Ref ZSCCVPCEPService
  ZSCCVPCEP:
    Description: Use this VPC EP for route nexthops
    Value: !Ref ZSCCVPCEP
  CloudConnectorGWLBTemplateVersion:
    Description: Cloud Connector Template Version
    Value: 0.1.3
